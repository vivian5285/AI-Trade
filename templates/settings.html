{% extends "base.html" %}

{% block title %}设置 - AI Trading System{% endblock %}

{% block content %}
<div class="container mt-4">
    <h2>交易设置</h2>
    
    <!-- 交易所选择卡片 -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">交易所选择</h5>
                </div>
                <div class="card-body">
                    <form id="exchangeForm">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-check mb-3">
                                    <input class="form-check-input" type="radio" name="exchange" id="binance" value="binance">
                                    <label class="form-check-label" for="binance">
                                        Binance
                                        <small class="text-muted d-block">API Key: {{ binance_api_key[:8] }}...{{ binance_api_key[-4:] }}</small>
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-check mb-3">
                                    <input class="form-check-input" type="radio" name="exchange" id="lbank" value="lbank">
                                    <label class="form-check-label" for="lbank">
                                        LBank
                                        <small class="text-muted d-block">API Key: {{ lbank_api_key[:8] }}...{{ lbank_api_key[-4:] }}</small>
                                    </label>
                                </div>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary">保存交易所选择</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- 策略选择卡片 -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">策略选择</h5>
                </div>
                <div class="card-body">
                    <form id="strategyForm">
                        <div class="row">
                            <!-- 基础策略 -->
                            <div class="col-md-3">
                                <div class="form-check mb-3">
                                    <input class="form-check-input" type="checkbox" id="scalpingEnabled" name="scalpingEnabled">
                                    <label class="form-check-label" for="scalpingEnabled">剥头皮策略</label>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-check mb-3">
                                    <input class="form-check-input" type="checkbox" id="supertrendEnabled" name="supertrendEnabled">
                                    <label class="form-check-label" for="supertrendEnabled">超级趋势过滤器</label>
                                </div>
                            </div>
                            <!-- 新增策略 -->
                            <div class="col-md-3">
                                <div class="form-check mb-3">
                                    <input class="form-check-input" type="checkbox" id="rsiEnabled" name="rsiEnabled">
                                    <label class="form-check-label" for="rsiEnabled">RSI + MACD + EMA</label>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-check mb-3">
                                    <input class="form-check-input" type="checkbox" id="bbEnabled" name="bbEnabled">
                                    <label class="form-check-label" for="bbEnabled">布林带 + 成交量</label>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-check mb-3">
                                    <input class="form-check-input" type="checkbox" id="ichimokuEnabled" name="ichimokuEnabled">
                                    <label class="form-check-label" for="ichimokuEnabled">一目均衡表</label>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-check mb-3">
                                    <input class="form-check-input" type="checkbox" id="vwapEnabled" name="vwapEnabled">
                                    <label class="form-check-label" for="vwapEnabled">VWAP + EMA</label>
                                </div>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary">保存策略选择</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- 基础交易设置 -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">基础交易设置</h5>
                </div>
                <div class="card-body">
                    <form id="basicForm">
                        <div class="row">
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label for="tradingPair">交易对</label>
                                    <select class="form-control" id="tradingPair" name="tradingPair">
                                        <option value="ETHUSDT">ETH/USDT</option>
                                        <option value="BTCUSDT">BTC/USDT</option>
                                        <option value="BNBUSDT">BNB/USDT</option>
                                        <option value="SOLUSDT">SOL/USDT</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label for="leverage">杠杆倍数</label>
                                    <input type="number" class="form-control" id="leverage" name="leverage" min="1" max="125" value="50">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label for="quantity">交易数量</label>
                                    <input type="number" class="form-control" id="quantity" name="quantity" min="0.001" step="0.001" value="0.001">
                                </div>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary">保存基础设置</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- 策略参数设置 -->
    <div class="row">
        <!-- RSI + MACD + EMA 策略参数 -->
        <div class="col-md-6 mb-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">RSI + MACD + EMA 策略参数</h5>
                </div>
                <div class="card-body">
                    <form id="rsiForm">
                        <div class="form-group">
                            <label for="rsiPeriod">RSI周期</label>
                            <input type="number" class="form-control" id="rsiPeriod" name="rsiPeriod" value="14">
                        </div>
                        <div class="form-group">
                            <label for="rsiOverbought">RSI超买值</label>
                            <input type="number" class="form-control" id="rsiOverbought" name="rsiOverbought" value="70">
                        </div>
                        <div class="form-group">
                            <label for="rsiOversold">RSI超卖值</label>
                            <input type="number" class="form-control" id="rsiOversold" name="rsiOversold" value="30">
                        </div>
                        <div class="form-group">
                            <label for="macdFast">MACD快线</label>
                            <input type="number" class="form-control" id="macdFast" name="macdFast" value="12">
                        </div>
                        <div class="form-group">
                            <label for="macdSlow">MACD慢线</label>
                            <input type="number" class="form-control" id="macdSlow" name="macdSlow" value="26">
                        </div>
                        <button type="submit" class="btn btn-primary">保存RSI参数</button>
                    </form>
                </div>
            </div>
        </div>

        <!-- 布林带 + 成交量策略参数 -->
        <div class="col-md-6 mb-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">布林带 + 成交量策略参数</h5>
                </div>
                <div class="card-body">
                    <form id="bbForm">
                        <div class="form-group">
                            <label for="bbPeriod">布林带周期</label>
                            <input type="number" class="form-control" id="bbPeriod" name="bbPeriod" value="20">
                        </div>
                        <div class="form-group">
                            <label for="bbStdDev">标准差倍数</label>
                            <input type="number" class="form-control" id="bbStdDev" name="bbStdDev" value="2">
                        </div>
                        <div class="form-group">
                            <label for="volumeProfilePeriod">成交量分布周期</label>
                            <input type="number" class="form-control" id="volumeProfilePeriod" name="volumeProfilePeriod" value="24">
                        </div>
                        <button type="submit" class="btn btn-primary">保存布林带参数</button>
                    </form>
                </div>
            </div>
        </div>

        <!-- 一目均衡表策略参数 -->
        <div class="col-md-6 mb-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">一目均衡表策略参数</h5>
                </div>
                <div class="card-body">
                    <form id="ichimokuForm">
                        <div class="form-group">
                            <label for="ichimokuTenkan">转换线周期</label>
                            <input type="number" class="form-control" id="ichimokuTenkan" name="ichimokuTenkan" value="9">
                        </div>
                        <div class="form-group">
                            <label for="ichimokuKijun">基准线周期</label>
                            <input type="number" class="form-control" id="ichimokuKijun" name="ichimokuKijun" value="26">
                        </div>
                        <div class="form-group">
                            <label for="ichimokuSenkouB">先行带B周期</label>
                            <input type="number" class="form-control" id="ichimokuSenkouB" name="ichimokuSenkouB" value="52">
                        </div>
                        <button type="submit" class="btn btn-primary">保存一目均衡表参数</button>
                    </form>
                </div>
            </div>
        </div>

        <!-- VWAP + EMA 策略参数 -->
        <div class="col-md-6 mb-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">VWAP + EMA 策略参数</h5>
                </div>
                <div class="card-body">
                    <form id="vwapForm">
                        <div class="form-group">
                            <label for="vwapPeriod">VWAP周期</label>
                            <input type="number" class="form-control" id="vwapPeriod" name="vwapPeriod" value="14">
                        </div>
                        <div class="form-group">
                            <label for="vwapDeviation">VWAP偏差</label>
                            <input type="number" class="form-control" id="vwapDeviation" name="vwapDeviation" value="2">
                        </div>
                        <div class="form-group">
                            <label for="vwapEmaFast">VWAP EMA快线</label>
                            <input type="number" class="form-control" id="vwapEmaFast" name="vwapEmaFast" value="8">
                        </div>
                        <div class="form-group">
                            <label for="vwapEmaSlow">VWAP EMA慢线</label>
                            <input type="number" class="form-control" id="vwapEmaSlow" name="vwapEmaSlow" value="21">
                        </div>
                        <button type="submit" class="btn btn-primary">保存VWAP参数</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // 加载当前设置
    fetch('/api/settings')
        .then(response => response.json())
        .then(data => {
            // 设置交易所选择
            document.querySelector(`input[name="exchange"][value="${data.exchange}"]`).checked = true;
            
            // 设置基础参数
            document.getElementById('tradingPair').value = data.tradingPair || 'ETHUSDT';
            document.getElementById('leverage').value = data.leverage || 50;
            document.getElementById('quantity').value = data.quantity || 0.001;
            
            // 设置策略启用状态
            document.getElementById('scalpingEnabled').checked = data.scalpingEnabled === 'true';
            document.getElementById('supertrendEnabled').checked = data.supertrendEnabled === 'true';
            document.getElementById('rsiEnabled').checked = data.rsiEnabled === 'true';
            document.getElementById('bbEnabled').checked = data.bbEnabled === 'true';
            document.getElementById('ichimokuEnabled').checked = data.ichimokuEnabled === 'true';
            document.getElementById('vwapEnabled').checked = data.vwapEnabled === 'true';
            
            // 设置策略参数
            if (data.rsiEnabled === 'true') {
                document.getElementById('rsiPeriod').value = data.rsiPeriod || 14;
                document.getElementById('rsiOverbought').value = data.rsiOverbought || 70;
                document.getElementById('rsiOversold').value = data.rsiOversold || 30;
                document.getElementById('macdFast').value = data.macdFast || 12;
                document.getElementById('macdSlow').value = data.macdSlow || 26;
            }
            
            if (data.bbEnabled === 'true') {
                document.getElementById('bbPeriod').value = data.bbPeriod || 20;
                document.getElementById('bbStdDev').value = data.bbStdDev || 2;
                document.getElementById('volumeProfilePeriod').value = data.volumeProfilePeriod || 24;
            }
            
            if (data.ichimokuEnabled === 'true') {
                document.getElementById('ichimokuTenkan').value = data.ichimokuTenkan || 9;
                document.getElementById('ichimokuKijun').value = data.ichimokuKijun || 26;
                document.getElementById('ichimokuSenkouB').value = data.ichimokuSenkouB || 52;
            }
            
            if (data.vwapEnabled === 'true') {
                document.getElementById('vwapPeriod').value = data.vwapPeriod || 14;
                document.getElementById('vwapDeviation').value = data.vwapDeviation || 2;
                document.getElementById('vwapEmaFast').value = data.vwapEmaFast || 8;
                document.getElementById('vwapEmaSlow').value = data.vwapEmaSlow || 21;
            }
        });

    // 保存交易所选择
    document.getElementById('exchangeForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const formData = new FormData(this);
        fetch('/api/settings/exchange', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('交易所选择已保存');
            } else {
                alert('保存失败：' + data.error);
            }
        });
    });

    // 保存基础设置
    document.getElementById('basicForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const formData = new FormData(this);
        fetch('/api/settings/basic', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('基础设置已保存');
            } else {
                alert('保存失败：' + data.error);
            }
        });
    });

    // 保存策略选择
    document.getElementById('strategyForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const formData = new FormData(this);
        fetch('/api/settings/strategy', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('策略选择已保存');
            } else {
                alert('保存失败：' + data.error);
            }
        });
    });

    // 保存各个策略的参数
    ['rsiForm', 'bbForm', 'ichimokuForm', 'vwapForm'].forEach(formId => {
        document.getElementById(formId).addEventListener('submit', function(e) {
            e.preventDefault();
            const formData = new FormData(this);
            fetch('/api/settings/strategy-params', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('策略参数已保存');
                } else {
                    alert('保存失败：' + data.error);
                }
            });
        });
    });
});
</script>
{% endblock %} 