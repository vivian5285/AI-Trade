{% extends "base.html" %}

{% block title %}仪表盘 - AI Trading System{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <!-- 市场概览卡片 -->
        <div class="col-md-6 mb-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">市场概览</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-6">
                            <h6>BTC/USDT</h6>
                            <p id="btc-price" class="h4 mb-2">加载中...</p>
                            <p id="btc-change" class="text-muted">24h变化: 加载中...</p>
                        </div>
                        <div class="col-6">
                            <h6>ETH/USDT</h6>
                            <p id="eth-price" class="h4 mb-2">加载中...</p>
                            <p id="eth-change" class="text-muted">24h变化: 加载中...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 账户概览卡片 -->
        <div class="col-md-6 mb-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">账户概览</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-6">
                            <h6>总余额</h6>
                            <p id="total-balance">加载中...</p>
                        </div>
                        <div class="col-6">
                            <h6>今日盈亏</h6>
                            <p id="daily-pnl">加载中...</p>
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-6">
                            <h6>持仓数量</h6>
                            <p id="open-positions">加载中...</p>
                        </div>
                        <div class="col-6">
                            <h6>持仓价值</h6>
                            <p id="total-position">加载中...</p>
                        </div>
                    </div>
                    <!-- 添加持仓详情 -->
                    <div class="mt-3">
                        <h6>持仓详情</h6>
                        <div id="positions-details">
                            <div class="table-responsive">
                                <table class="table table-sm">
                                    <thead>
                                        <tr>
                                            <th>交易所</th>
                                            <th>资产</th>
                                            <th>可用</th>
                                            <th>冻结</th>
                                        </tr>
                                    </thead>
                                    <tbody id="positions-table">
                                        <tr>
                                            <td colspan="4" class="text-center">加载中...</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 在交易机器人控制面板之前添加K线图表 -->
    <div class="card mb-4">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0">K线图表</h5>
            <div class="d-flex align-items-center">
                <select id="timeframe" class="form-select form-select-sm me-2" style="width: auto;">
                    <option value="1m">1分钟</option>
                    <option value="5m">5分钟</option>
                    <option value="15m">15分钟</option>
                    <option value="1h">1小时</option>
                    <option value="4h">4小时</option>
                    <option value="1d">1天</option>
                </select>
                <select id="symbol" class="form-select form-select-sm" style="width: auto;">
                    <option value="BTCUSDT">BTC/USDT</option>
                    <option value="ETHUSDT">ETH/USDT</option>
                </select>
            </div>
        </div>
        <div class="card-body">
            <div id="kline-chart" style="height: 400px;"></div>
        </div>
    </div>

    <!-- 在交易机器人控制面板之前添加策略参数配置 -->
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="mb-0">策略参数</h5>
        </div>
        <div class="card-body">
            <form id="strategy-settings">
                <div class="row">
                    <div class="col-md-6">
                        <h6>RSI策略</h6>
                        <div class="mb-3">
                            <label class="form-label">RSI周期</label>
                            <input type="number" class="form-control" name="rsi_period" value="14" min="1" max="100">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">超买阈值</label>
                            <input type="number" class="form-control" name="rsi_overbought" value="70" min="50" max="100">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">超卖阈值</label>
                            <input type="number" class="form-control" name="rsi_oversold" value="30" min="0" max="50">
                        </div>
                    </div>
                    <div class="col-md-6">
                        <h6>布林带策略</h6>
                        <div class="mb-3">
                            <label class="form-label">周期</label>
                            <input type="number" class="form-control" name="bb_period" value="20" min="1" max="100">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">标准差倍数</label>
                            <input type="number" class="form-control" name="bb_std" value="2" min="0.1" max="5" step="0.1">
                        </div>
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-md-6">
                        <h6>SuperTrend策略</h6>
                        <div class="mb-3">
                            <label class="form-label">ATR周期</label>
                            <input type="number" class="form-control" name="supertrend_atr_period" value="10" min="1" max="100">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">ATR倍数</label>
                            <input type="number" class="form-control" name="supertrend_atr_multiplier" value="2" min="0.1" max="5" step="0.1">
                        </div>
                    </div>
                    <div class="col-md-6">
                        <h6>网格策略</h6>
                        <div class="mb-3">
                            <label class="form-label">网格数量</label>
                            <input type="number" class="form-control" name="grid_count" value="10" min="1" max="100">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">网格间距(%)</label>
                            <input type="number" class="form-control" name="grid_spacing" value="1" min="0.1" max="10" step="0.1">
                        </div>
                    </div>
                </div>
                <div class="text-end mt-3">
                    <button type="submit" class="btn btn-primary">保存设置</button>
                </div>
            </form>
        </div>
    </div>

    <!-- 交易机器人控制面板 -->
    <div class="row mb-4" id="trading-bot">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">交易机器人控制</h5>
                </div>
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-md-3">
                            <div class="d-flex align-items-center">
                                <div class="status-indicator me-2" id="bot-status-indicator"></div>
                                <span id="bot-status-text">状态: 检查中...</span>
                            </div>
                        </div>
                        <div class="col-md-9">
                            <button class="btn btn-success me-2" id="start-bot">启动</button>
                            <button class="btn btn-danger me-2" id="stop-bot">停止</button>
                            <button class="btn btn-warning" id="restart-bot">重启</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 交易历史卡片 -->
    <div class="row">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">最近交易</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>交易所</th>
                                    <th>交易对</th>
                                    <th>方向</th>
                                    <th>价格</th>
                                    <th>数量</th>
                                    <th>时间</th>
                                    <th>状态</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for trade in trades %}
                                <tr>
                                    <td>{{ trade.exchange }}</td>
                                    <td>{{ trade.symbol }}</td>
                                    <td>{{ trade.side }}</td>
                                    <td>{{ trade.price }}</td>
                                    <td>{{ trade.quantity }}</td>
                                    <td>{{ trade.timestamp.strftime('%Y-%m-%d %H:%M:%S') }}</td>
                                    <td>
                                        <span class="badge {% if trade.status == 'CLOSED' %}bg-success{% elif trade.status == 'OPEN' %}bg-warning{% else %}bg-danger{% endif %}">
                                            {{ trade.status }}
                                        </span>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 添加持仓详情卡片 -->
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="card-title mb-0">持仓详情</h5>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>交易所</th>
                            <th>资产</th>
                            <th>可用数量</th>
                            <th>冻结数量</th>
                            <th>当前价格</th>
                            <th>持仓价值</th>
                            <th>杠杆</th>
                            <th>未实现盈亏</th>
                            <th>强平价格</th>
                        </tr>
                    </thead>
                    <tbody id="positionsTable">
                        <!-- 持仓数据将通过JavaScript动态填充 -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/lightweight-charts/dist/lightweight-charts.standalone.production.js"></script>

<script>
// 初始化K线图表
let chart = null;
let candlestickSeries = null;

function initChart() {
    const chartContainer = document.getElementById('kline-chart');
    chart = LightweightCharts.createChart(chartContainer, {
        width: chartContainer.clientWidth,
        height: 400,
        layout: {
            backgroundColor: '#ffffff',
            textColor: '#333',
        },
        grid: {
            vertLines: { color: '#f0f0f0' },
            horzLines: { color: '#f0f0f0' },
        },
        timeScale: {
            timeVisible: true,
            secondsVisible: false,
        },
    });
    
    candlestickSeries = chart.addCandlestickSeries({
        upColor: '#26a69a',
        downColor: '#ef5350',
        borderVisible: false,
        wickUpColor: '#26a69a',
        wickDownColor: '#ef5350',
    });
    
    // 添加成交量图表
    const volumeSeries = chart.addHistogramSeries({
        color: '#26a69a',
        priceFormat: {
            type: 'volume',
        },
        priceScaleId: '',
        scaleMargins: {
            top: 0.8,
            bottom: 0,
        },
    });
    
    // 响应式调整
    window.addEventListener('resize', () => {
        chart.applyOptions({
            width: chartContainer.clientWidth
        });
    });
}

// 更新K线图表
function updateKlineChart() {
    const symbol = document.getElementById('symbol').value;
    const timeframe = document.getElementById('timeframe').value;
    
    fetch(`/api/kline-data?symbol=${symbol}&timeframe=${timeframe}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const klines = data.data.map(k => ({
                    time: new Date(k.timestamp).getTime() / 1000,
                    open: parseFloat(k.open),
                    high: parseFloat(k.high),
                    low: parseFloat(k.low),
                    close: parseFloat(k.close),
                    volume: parseFloat(k.volume)
                }));
                
                candlestickSeries.setData(klines);
            }
        })
        .catch(error => console.error('Error updating kline chart:', error));
}

// 保存策略设置
document.getElementById('strategy-settings').addEventListener('submit', function(e) {
    e.preventDefault();
    const formData = new FormData(this);
    const settings = {};
    for (let [key, value] of formData.entries()) {
        settings[key] = value;
    }
    
    fetch('/api/save-strategy-settings', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(settings)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('设置已保存');
        } else {
            alert('保存设置失败: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error saving settings:', error);
        alert('保存设置失败');
    });
});

// 更新市场数据
function updateMarketData() {
    fetch('/api/market-data')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // 更新BTC数据
                const btcPrice = document.getElementById('btc-price');
                const btcChange = document.getElementById('btc-change');
                btcPrice.textContent = data.btc.price;
                btcChange.textContent = `24h变化: ${data.btc.change}`;
                btcChange.className = data.btc.change.startsWith('+') ? 'text-success' : 'text-danger';
                
                // 更新ETH数据
                const ethPrice = document.getElementById('eth-price');
                const ethChange = document.getElementById('eth-change');
                ethPrice.textContent = data.eth.price;
                ethChange.textContent = `24h变化: ${data.eth.change}`;
                ethChange.className = data.eth.change.startsWith('+') ? 'text-success' : 'text-danger';
            } else {
                console.error('Error fetching market data:', data.error);
            }
        })
        .catch(error => {
            console.error('Error fetching market data:', error);
        });
}

// 更新账户数据
function updateAccountData() {
    fetch('/api/account-data')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                document.getElementById('total-balance').textContent = data.balance;
                document.getElementById('daily-pnl').textContent = data.daily_pnl;
                document.getElementById('open-positions').textContent = data.open_positions;
                document.getElementById('total-position').textContent = data.total_position;
                
                // 更新持仓详情表格
                const positionsTable = document.getElementById('positions-table');
                if (data.positions && data.positions.length > 0) {
                    positionsTable.innerHTML = data.positions.map(position => `
                        <tr>
                            <td>${position.exchange}</td>
                            <td>${position.asset}</td>
                            <td>${position.free.toFixed(8)}</td>
                            <td>${position.locked.toFixed(8)}</td>
                        </tr>
                    `).join('');
                } else {
                    positionsTable.innerHTML = '<tr><td colspan="4" class="text-center">暂无持仓</td></tr>';
                }
            } else {
                console.error('Error fetching account data:', data.error);
            }
        })
        .catch(error => {
            console.error('Error fetching account data:', error);
        });
}

// 更新交易机器人状态
function updateBotStatus() {
    fetch('/api/trading-bot/status')
        .then(response => response.json())
        .then(data => {
            const indicator = document.getElementById('bot-status-indicator');
            const statusText = document.getElementById('bot-status-text');
            const startBtn = document.getElementById('start-bot');
            const stopBtn = document.getElementById('stop-bot');
            
            if (data.is_running) {
                indicator.style.backgroundColor = '#28a745';
                statusText.textContent = '状态: 运行中';
                startBtn.disabled = true;
                stopBtn.disabled = false;
            } else {
                indicator.style.backgroundColor = '#dc3545';
                statusText.textContent = '状态: 已停止';
                startBtn.disabled = false;
                stopBtn.disabled = true;
            }
        });
}

// 启动交易机器人
document.getElementById('start-bot').addEventListener('click', function() {
    fetch('/api/trading-bot/start', { method: 'POST' })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                updateBotStatus();
            } else {
                alert('启动失败: ' + data.error);
            }
        });
});

// 停止交易机器人
document.getElementById('stop-bot').addEventListener('click', function() {
    fetch('/api/trading-bot/stop', { method: 'POST' })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                updateBotStatus();
            } else {
                alert('停止失败: ' + data.error);
            }
        });
});

// 重启交易机器人
document.getElementById('restart-bot').addEventListener('click', function() {
    fetch('/api/trading-bot/restart', { method: 'POST' })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                updateBotStatus();
            } else {
                alert('重启失败: ' + data.error);
            }
        });
});

// 更新持仓数据
function updatePositionsData() {
    fetch('/api/account-data')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const positionsTable = document.getElementById('positionsTable');
                positionsTable.innerHTML = '';
                
                if (data.positions && data.positions.length > 0) {
                    data.positions.forEach(position => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${position.exchange}</td>
                            <td>${position.asset}</td>
                            <td>${position.free.toFixed(8)}</td>
                            <td>${position.locked.toFixed(8)}</td>
                            <td>$${position.price.toFixed(2)}</td>
                            <td>$${position.value.toFixed(2)}</td>
                            <td>${position.leverage ? position.leverage + 'x' : '-'}</td>
                            <td class="${position.unrealized_pnl >= 0 ? 'text-success' : 'text-danger'}">
                                ${position.unrealized_pnl ? '$' + position.unrealized_pnl.toFixed(2) : '-'}
                            </td>
                            <td>${position.liquidation_price ? '$' + position.liquidation_price.toFixed(2) : '-'}</td>
                        `;
                        positionsTable.appendChild(row);
                    });
                } else {
                    positionsTable.innerHTML = '<tr><td colspan="9" class="text-center">暂无持仓</td></tr>';
                }
            }
        })
        .catch(error => console.error('Error updating positions data:', error));
}

// 在页面加载时初始化
document.addEventListener('DOMContentLoaded', function() {
    // 初始化图表
    initChart();
    
    // 立即更新数据
    updateMarketData();
    updateAccountData();
    updatePositionsData();
    updateKlineChart();
    
    // 设置定时更新
    setInterval(updateMarketData, 5000);  // 每5秒更新市场数据
    setInterval(updateAccountData, 10000);  // 每10秒更新账户数据
    setInterval(updatePositionsData, 10000);  // 每10秒更新持仓数据
    setInterval(updateKlineChart, 5000);  // 每5秒更新K线图表
    
    // 监听时间周期和交易对选择变化
    document.getElementById('timeframe').addEventListener('change', updateKlineChart);
    document.getElementById('symbol').addEventListener('change', updateKlineChart);
    
    // 检查是否需要滚动到交易机器人部分
    if (window.location.hash === '#trading-bot') {
        const tradingBotSection = document.getElementById('trading-bot');
        if (tradingBotSection) {
            tradingBotSection.scrollIntoView({ behavior: 'smooth' });
        }
    }
});
</script>
{% endblock %}

<style>
.status-indicator {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    background-color: #dc3545;
    display: inline-block;
}
.status-indicator.active {
    background-color: #28a745;
}
</style> 