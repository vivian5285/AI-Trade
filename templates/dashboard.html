{% extends "base.html" %}

{% block title %}仪表盘 - AI Trading System{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <!-- 市场概览卡片 -->
        <div class="col-md-6 mb-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">市场概览</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-6">
                            <h6>BTC/USDT</h6>
                            <p id="btc-price">加载中...</p>
                            <p id="btc-change" class="text-muted">24h变化: 加载中...</p>
                        </div>
                        <div class="col-6">
                            <h6>ETH/USDT</h6>
                            <p id="eth-price">加载中...</p>
                            <p id="eth-change" class="text-muted">24h变化: 加载中...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 账户概览卡片 -->
        <div class="col-md-6 mb-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">账户概览</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-6">
                            <h6>总余额</h6>
                            <p id="total-balance">加载中...</p>
                        </div>
                        <div class="col-6">
                            <h6>今日盈亏</h6>
                            <p id="daily-pnl">加载中...</p>
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-6">
                            <h6>持仓数量</h6>
                            <p id="open-positions">加载中...</p>
                        </div>
                        <div class="col-6">
                            <h6>持仓价值</h6>
                            <p id="total-position">加载中...</p>
                        </div>
                    </div>
                    <!-- 添加持仓详情 -->
                    <div class="mt-3">
                        <h6>持仓详情</h6>
                        <div id="positions-details">
                            <div class="table-responsive">
                                <table class="table table-sm">
                                    <thead>
                                        <tr>
                                            <th>交易所</th>
                                            <th>资产</th>
                                            <th>可用</th>
                                            <th>冻结</th>
                                        </tr>
                                    </thead>
                                    <tbody id="positions-table">
                                        <tr>
                                            <td colspan="4" class="text-center">加载中...</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 交易机器人控制面板 -->
    <div class="row mb-4" id="trading-bot">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">交易机器人控制</h5>
                </div>
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-md-3">
                            <div class="d-flex align-items-center">
                                <div class="status-indicator me-2" id="bot-status-indicator"></div>
                                <span id="bot-status-text">状态: 检查中...</span>
                            </div>
                        </div>
                        <div class="col-md-9">
                            <button class="btn btn-success me-2" id="start-bot">启动</button>
                            <button class="btn btn-danger me-2" id="stop-bot">停止</button>
                            <button class="btn btn-warning" id="restart-bot">重启</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 交易历史卡片 -->
    <div class="row">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">最近交易</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>交易所</th>
                                    <th>交易对</th>
                                    <th>方向</th>
                                    <th>价格</th>
                                    <th>数量</th>
                                    <th>时间</th>
                                    <th>状态</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for trade in trades %}
                                <tr>
                                    <td>{{ trade.exchange }}</td>
                                    <td>{{ trade.symbol }}</td>
                                    <td>{{ trade.side }}</td>
                                    <td>{{ trade.price }}</td>
                                    <td>{{ trade.quantity }}</td>
                                    <td>{{ trade.timestamp.strftime('%Y-%m-%d %H:%M:%S') }}</td>
                                    <td>
                                        <span class="badge {% if trade.status == 'CLOSED' %}bg-success{% elif trade.status == 'OPEN' %}bg-warning{% else %}bg-danger{% endif %}">
                                            {{ trade.status }}
                                        </span>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// 更新市场数据
function updateMarketData() {
    fetch('/api/market-data')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                document.getElementById('btc-price').textContent = data.btc.price;
                document.getElementById('btc-change').textContent = data.btc.change;
                document.getElementById('eth-price').textContent = data.eth.price;
                document.getElementById('eth-change').textContent = data.eth.change;
            } else {
                console.error('Error fetching market data:', data.error);
            }
        })
        .catch(error => {
            console.error('Error fetching market data:', error);
        });
}

// 更新账户数据
function updateAccountData() {
    fetch('/api/account-data')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                document.getElementById('total-balance').textContent = data.balance;
                document.getElementById('daily-pnl').textContent = data.daily_pnl;
                document.getElementById('open-positions').textContent = data.open_positions;
                document.getElementById('total-position').textContent = data.total_position;
                
                // 更新持仓详情表格
                const positionsTable = document.getElementById('positions-table');
                if (data.positions && data.positions.length > 0) {
                    positionsTable.innerHTML = data.positions.map(position => `
                        <tr>
                            <td>${position.exchange}</td>
                            <td>${position.asset}</td>
                            <td>${position.free.toFixed(8)}</td>
                            <td>${position.locked.toFixed(8)}</td>
                        </tr>
                    `).join('');
                } else {
                    positionsTable.innerHTML = '<tr><td colspan="4" class="text-center">暂无持仓</td></tr>';
                }
            } else {
                console.error('Error fetching account data:', data.error);
            }
        })
        .catch(error => {
            console.error('Error fetching account data:', error);
        });
}

// 更新交易机器人状态
function updateBotStatus() {
    fetch('/api/trading-bot/status')
        .then(response => response.json())
        .then(data => {
            const indicator = document.getElementById('bot-status-indicator');
            const statusText = document.getElementById('bot-status-text');
            const startBtn = document.getElementById('start-bot');
            const stopBtn = document.getElementById('stop-bot');
            
            if (data.is_running) {
                indicator.style.backgroundColor = '#28a745';
                statusText.textContent = '状态: 运行中';
                startBtn.disabled = true;
                stopBtn.disabled = false;
            } else {
                indicator.style.backgroundColor = '#dc3545';
                statusText.textContent = '状态: 已停止';
                startBtn.disabled = false;
                stopBtn.disabled = true;
            }
        });
}

// 启动交易机器人
document.getElementById('start-bot').addEventListener('click', function() {
    fetch('/api/trading-bot/start', { method: 'POST' })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                updateBotStatus();
            } else {
                alert('启动失败: ' + data.error);
            }
        });
});

// 停止交易机器人
document.getElementById('stop-bot').addEventListener('click', function() {
    fetch('/api/trading-bot/stop', { method: 'POST' })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                updateBotStatus();
            } else {
                alert('停止失败: ' + data.error);
            }
        });
});

// 重启交易机器人
document.getElementById('restart-bot').addEventListener('click', function() {
    fetch('/api/trading-bot/restart', { method: 'POST' })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                updateBotStatus();
            } else {
                alert('重启失败: ' + data.error);
            }
        });
});

// 页面加载完成后开始更新数据
document.addEventListener('DOMContentLoaded', function() {
    // 立即更新一次数据
    updateMarketData();
    updateAccountData();
    
    // 每5秒更新一次市场数据
    setInterval(updateMarketData, 5000);
    
    // 每10秒更新一次账户数据
    setInterval(updateAccountData, 10000);
    
    // 检查是否需要滚动到交易机器人部分
    if (window.location.hash === '#trading-bot') {
        const tradingBotSection = document.getElementById('trading-bot');
        if (tradingBotSection) {
            tradingBotSection.scrollIntoView({ behavior: 'smooth' });
        }
    }
});
</script>
{% endblock %}

<style>
.status-indicator {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    background-color: #dc3545;
    display: inline-block;
}
.status-indicator.active {
    background-color: #28a745;
}
</style> 