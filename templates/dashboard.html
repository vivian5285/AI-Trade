{% extends "base.html" %}

{% block title %}仪表盘 - AI Trading System{% endblock %}

{% block content %}
<div class="container mt-5">
    <div class="row">
        <!-- 账户概览卡片（只保留所需三项） -->
        <div class="col-md-12 mb-4">
            <div class="card shadow-sm">
                <div class="card-body">
                    <h5 class="card-title">账户概览</h5>
                    <div class="row text-center">
                        <div class="col-md-3">
                            <div class="card">
                                <div class="card-body">
                                    <h5 class="card-title">总权益</h5>
                                    <h3 id="total-balance">$0.00</h3>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card">
                                <div class="card-body">
                                    <h5 class="card-title">今日盈亏</h5>
                                    <h3 id="daily-pnl">$0.00</h3>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card">
                                <div class="card-body">
                                    <h5 class="card-title">未实现盈亏</h5>
                                    <h3 id="unrealized-pnl">$0.00</h3>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card">
                                <div class="card-body">
                                    <h5 class="card-title">持仓数量</h5>
                                    <h3 id="position-count">0</h3>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- 持仓详情表格 -->
    <div class="row">
        <div class="col-md-12">
            <div class="card shadow-sm">
                <div class="card-body">
                    <h5 class="card-title">持仓详情</h5>
                    <div class="table-responsive">
                        <table class="table table-bordered table-hover">
                            <thead class="thead-light">
                                <tr>
                                    <th>币种</th>
                                    <th>可用</th>
                                    <th>冻结</th>
                                    <th>价值(USDT)</th>
                                </tr>
                            </thead>
                            <tbody id="positionsTable">
                                <tr><td colspan="4" class="text-center">加载中...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 持仓列表 -->
    <div class="card mt-4">
        <div class="card-header">
            <h5 class="mb-0">当前持仓</h5>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover" id="positions-table">
                    <thead>
                        <tr>
                            <th>交易对</th>
                            <th>方向</th>
                            <th>数量</th>
                            <th>杠杆</th>
                            <th>开仓价</th>
                            <th>标记价</th>
                            <th>未实现盈亏</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td colspan="7" class="text-center">暂无持仓</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function setLoading(elementId, isLoading) {
    const element = document.getElementById(elementId);
    if (isLoading) {
        element.textContent = '加载中...';
        element.classList.add('text-muted');
    }
}

function updateAccountData() {
    setLoading('daily-pnl', true);
    setLoading('open-positions', true);
    setLoading('total-position', true);

    fetch('/api/account-data')
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                console.error('Error fetching account data:', data.error);
                return;
            }
            
            // 更新总余额
            document.getElementById('total-balance').textContent = 
                `$${data.total_balance.toFixed(2)}`;
            
            // 更新今日盈亏
            const dailyPnlElement = document.getElementById('daily-pnl');
            dailyPnlElement.textContent = `$${data.daily_pnl.toFixed(2)}`;
            dailyPnlElement.className = data.daily_pnl >= 0 ? 'text-success' : 'text-danger';
            
            // 更新未实现盈亏
            const unrealizedPnlElement = document.getElementById('unrealized-pnl');
            unrealizedPnlElement.textContent = `$${data.unrealized_pnl.toFixed(2)}`;
            unrealizedPnlElement.className = data.unrealized_pnl >= 0 ? 'text-success' : 'text-danger';
            
            // 更新持仓数量
            document.getElementById('position-count').textContent = 
                data.positions.length;
            
            // 更新持仓列表
            const positionsTable = document.getElementById('positions-table');
            positionsTable.innerHTML = `
                <thead>
                    <tr>
                        <th>交易对</th>
                        <th>方向</th>
                        <th>数量</th>
                        <th>杠杆</th>
                        <th>开仓价</th>
                        <th>标记价</th>
                        <th>未实现盈亏</th>
                    </tr>
                </thead>
                <tbody>
                    ${data.positions.map(position => `
                        <tr>
                            <td>${position.symbol}</td>
                            <td class="${position.side === 'LONG' ? 'text-success' : 'text-danger'}">
                                ${position.side}
                            </td>
                            <td>${Math.abs(position.amount).toFixed(4)}</td>
                            <td>${position.leverage}x</td>
                            <td>$${position.entry_price.toFixed(2)}</td>
                            <td>$${position.mark_price.toFixed(2)}</td>
                            <td class="${position.unrealized_pnl >= 0 ? 'text-success' : 'text-danger'}">
                                $${position.unrealized_pnl.toFixed(2)}
                            </td>
                        </tr>
                    `).join('')}
                </tbody>
            `;
        })
        .catch(error => {
            console.error('Error:', error);
        });
}

document.addEventListener('DOMContentLoaded', function() {
    updateAccountData();
    setInterval(updateAccountData, 10000); // 每10秒刷新一次
});
</script>
{% endblock %}

<style>
.status-indicator {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    background-color: #dc3545;
    display: inline-block;
}
.status-indicator.active {
    background-color: #28a745;
}
</style> 