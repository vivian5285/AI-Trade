{% extends "base.html" %}

{% block title %}仪表盘 - AI Trading System{% endblock %}

{% block content %}
<div class="container mt-5">
    <div class="row">
        <!-- 账户概览卡片（只保留所需三项） -->
        <div class="col-md-12 mb-4">
            <div class="card shadow-sm">
                <div class="card-body">
                    <h5 class="card-title">账户概览</h5>
                    <div class="row text-center">
                        <div class="col-md-4 col-4 mb-2">
                            <div class="text-muted">今日盈亏</div>
                            <div id="daily-pnl" class="h5">加载中...</div>
                        </div>
                        <div class="col-md-4 col-4 mb-2">
                            <div class="text-muted">持仓数量</div>
                            <div id="open-positions" class="h5">加载中...</div>
                        </div>
                        <div class="col-md-4 col-4 mb-2">
                            <div class="text-muted">持仓价值</div>
                            <div id="total-position" class="h5">加载中...</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- 持仓详情表格 -->
    <div class="row">
        <div class="col-md-12">
            <div class="card shadow-sm">
                <div class="card-body">
                    <h5 class="card-title">持仓详情</h5>
                    <div class="table-responsive">
                        <table class="table table-bordered table-hover">
                            <thead class="thead-light">
                                <tr>
                                    <th>币种</th>
                                    <th>可用</th>
                                    <th>冻结</th>
                                    <th>价值(USDT)</th>
                                </tr>
                            </thead>
                            <tbody id="positionsTable">
                                <tr><td colspan="4" class="text-center">加载中...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function setLoading(elementId, isLoading) {
    const element = document.getElementById(elementId);
    if (isLoading) {
        element.textContent = '加载中...';
        element.classList.add('text-muted');
    }
}

function updateAccountData() {
    setLoading('daily-pnl', true);
    setLoading('open-positions', true);
    setLoading('total-position', true);

    fetch('/api/account-data')
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            if (data.error) {
                console.error('Error fetching account data:', data.error);
                return;
            }
            // 更新今日盈亏
            const dailyPnl = document.getElementById('daily-pnl');
            dailyPnl.textContent = `$${data.daily_pnl.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
            dailyPnl.className = data.daily_pnl >= 0 ? 'text-success' : 'text-danger';
            // 更新持仓数量
            const openPositions = document.getElementById('open-positions');
            openPositions.textContent = data.positions.length;
            // 更新持仓价值
            const totalPosition = document.getElementById('total-position');
            const totalPositionValue = data.positions.reduce((sum, pos) => sum + pos.value, 0);
            totalPosition.textContent = `$${totalPositionValue.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
            // 更新持仓表格
            updatePositionsTable(data.positions);
        })
        .catch(error => {
            console.error('Error fetching account data:', error);
            document.getElementById('daily-pnl').textContent = '加载失败';
            document.getElementById('open-positions').textContent = '加载失败';
            document.getElementById('total-position').textContent = '加载失败';
            updatePositionsTable([]);
        });
}

function updatePositionsTable(positions) {
    const positionsTable = document.getElementById('positionsTable');
    positionsTable.innerHTML = '';
    if (!positions || positions.length === 0) {
        const row = document.createElement('tr');
        row.innerHTML = '<td colspan="4" class="text-center">暂无持仓</td>';
        positionsTable.appendChild(row);
        return;
    }
    positions.forEach(position => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${position.asset}</td>
            <td>${position.free.toFixed(8)}</td>
            <td>${position.locked.toFixed(8)}</td>
            <td>$${position.value.toFixed(2)}</td>
        `;
        positionsTable.appendChild(row);
    });
}

document.addEventListener('DOMContentLoaded', function() {
    updateAccountData();
    setInterval(updateAccountData, 10000); // 每10秒刷新一次
});
</script>
{% endblock %}

<style>
.status-indicator {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    background-color: #dc3545;
    display: inline-block;
}
.status-indicator.active {
    background-color: #28a745;
}
</style> 